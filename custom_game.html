<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Game</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Add your CSS styling here */
        #puzzle-outline {
            border: 2px dashed black;
            width: fit-content;
            margin: auto;
            margin-bottom: 20px;
            padding: 10px;
        }

        #puzzle-container {
            display: flex;
            flex-wrap: wrap;
            border: 2px solid black;
            width: 300px;
            height: 300px;
            margin: auto;
            margin-bottom: 20px;
            position: relative;
        }

        .puzzle-piece {
            width: calc(100% / 3 - 4px);
            height: calc(100% / 3 - 4px);
            margin: 2px;
            border: 2px solid transparent;
            background-size: cover;
            cursor: pointer;
        }

        #counter {
            text-align: center;
            margin-bottom: 20px;
        }

        #all-pieces-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Custom Game</h1>
        <div id="puzzle-outline">
            <div id="puzzle-container"></div>
        </div>
        <div id="counter">Moves: <span id="moveCounter">0</span></div>
        <div id="all-pieces-container"></div>
        <div id="message"></div>
    </div>
    <script src="script.js"></script>
    <script>
        let correctOrder;
        let currentOrder;
        let emptyIndex;
        let moveCounter = 0;

        window.onload = function () {
            const imageSrc = localStorage.getItem('customImageSrc');
            const puzzleContainer = document.getElementById('puzzle-container');
            const allPiecesContainer = document.getElementById('all-pieces-container');
            const message = document.getElementById('message');

            if (imageSrc) {
                const img = new Image();
                img.src = imageSrc;

                img.onload = function () {
                    puzzleContainer.innerHTML = '';
                    allPiecesContainer.innerHTML = '';
                    correctOrder = [];
                    currentOrder = [];
                    emptyIndex = 8;
					const puzzleContainerWidth = puzzleContainer.clientWidth;
					const puzzleContainerHeight = puzzleContainer.clientHeight;
					const aspectRatio = img.width / img.height;

					let pieceWidth, pieceHeight;

					if (aspectRatio > 1) { // Landscape orientation
						pieceWidth = puzzleContainerWidth / 3;
						pieceHeight = pieceWidth / aspectRatio;
					} else { // Portrait or square orientation
						pieceHeight = puzzleContainerHeight / 3;
						pieceWidth = pieceHeight * aspectRatio;
					}
                    for (let i = 0; i < 3; i++) {
                        for (let j = 0; j < 3; j++) {
                            const canvas = document.createElement('canvas');
                            canvas.width = pieceWidth;
                            canvas.height = pieceHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, j * pieceWidth, i * pieceHeight, pieceWidth, pieceHeight, 0, 0, pieceWidth, pieceHeight);

                            const puzzlePiece = document.createElement('div');
                            puzzlePiece.className = 'puzzle-piece';
                            puzzlePiece.style.backgroundImage = `url(${canvas.toDataURL()})`;
                            puzzlePiece.setAttribute('data-index', i * 3 + j);
                            puzzlePiece.addEventListener('click', movePiece);
                            puzzlePiece.setAttribute('draggable', true);
                            puzzlePiece.addEventListener('dragstart', dragStart);
                            puzzlePiece.addEventListener('dragover', dragOver);
                            puzzlePiece.addEventListener('drop', drop);
                            allPiecesContainer.appendChild(puzzlePiece);

                            correctOrder.push(i * 3 + j);
                            currentOrder.push(i * 3 + j);
                        }
                    }

                    shuffleArray(currentOrder);
                };
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function movePiece(event) {
                const clickedIndex = parseInt(event.target.getAttribute('data-index'));
                const clickedRow = Math.floor(clickedIndex / 3);
                const clickedCol = clickedIndex % 3;
                const emptyRow = Math.floor(emptyIndex / 3);
                const emptyCol = emptyIndex % 3;

                if ((Math.abs(clickedRow - emptyRow) === 1 && clickedCol === emptyCol) ||
                    (Math.abs(clickedCol - emptyCol) === 1 && clickedRow === emptyRow)) {
                    const clickedPiece = event.target;
                    const emptyPiece = document.querySelector(`[data-index='${emptyIndex}']`);

                    clickedPiece.style.order = emptyIndex;
                    emptyPiece.style.order = clickedIndex;

                    const temp = currentOrder[clickedIndex];
                    currentOrder[clickedIndex] = currentOrder[emptyIndex];
                    currentOrder[emptyIndex] = temp;

                    emptyIndex = clickedIndex;

                    moveCounter++;
                    document.getElementById('moveCounter').textContent = moveCounter;

                    checkIfCorrect();
                }
            }

            function checkIfCorrect() {
                let correct = true;
                for (let i = 0; i < currentOrder.length; i++) {
                    if (currentOrder[i] !== correctOrder[i]) {
                        correct = false;
                        break;
                    }
                }

                if (correct) {
                    message.textContent = 'Congratulations! Puzzle solved!';
                    puzzleContainer.classList.add('correct');
                } else {
                    message.textContent = '';
                    puzzleContainer.classList.remove('correct');
                }
            }

            function dragStart(event) {
                event.dataTransfer.setData('text/plain', event.target.dataset.index);
            }

            function dragOver(event) {
                event.preventDefault();
            }

            function drop(event) {
                event.preventDefault();
                const data = event.dataTransfer.getData('text/plain');
                const draggedIndex = parseInt(data);
                const droppedIndex = parseInt(event.target.dataset.index);
                const draggedPiece = document.querySelector(`[data-index='${draggedIndex}']`);

                // Swap the order attribute and the currentOrder array elements
                draggedPiece.style.order = droppedIndex;
                event.target.style.order = draggedIndex;
                const temp = currentOrder[droppedIndex];
                currentOrder[droppedIndex] = currentOrder[draggedIndex];
                currentOrder[draggedIndex] = temp;

                emptyIndex = draggedIndex;

                moveCounter++;
                document.getElementById('moveCounter').textContent = moveCounter;

                checkIfCorrect();
            }
        }
    </script>
</body>
</html>
